name: Check OpenClaw Release

on:
  schedule:
    # 每天检查两次：早上8点和晚上8点 (UTC)
    - cron: '0 8,20 * * *'
  workflow_dispatch:

jobs:
  check-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get latest OpenClaw tag
        id: openclaw
        run: |
          # 获取 OpenClaw 的最新 tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/openclaw/openclaw/tags | jq -r '.[0].name')
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest OpenClaw tag: $LATEST_TAG"
          
          # 检查本地记录的版本
          if [ -f .openclaw-version ]; then
            CURRENT_VERSION=$(cat .openclaw-version)
          else
            CURRENT_VERSION="none"
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current tracked version: $CURRENT_VERSION"
          
          # 比较版本
          if [ "$LATEST_TAG" != "$CURRENT_VERSION" ]; then
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "New release detected!"
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
            echo "No new release"
          fi
      
      - name: Update version file
        if: steps.openclaw.outputs.new_release == 'true'
        run: |
          echo "${{ steps.openclaw.outputs.latest_tag }}" > .openclaw-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .openclaw-version
          git commit -m "Update OpenClaw version to ${{ steps.openclaw.outputs.latest_tag }}"
          git push
      
      - name: Trigger OpenClaw build
        if: steps.openclaw.outputs.new_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker-build-push.yml',
              ref: 'main'
            });
            console.log('Triggered Docker build for OpenClaw version ${{ steps.openclaw.outputs.latest_tag }}');
